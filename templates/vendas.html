
{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between mb-3">
    <a href="/dashboard" class="btn btn-secondary">
        ‚Üê Voltar
    </a>

    <button onclick="location.reload()"
            class="btn btn-dark">
        Nova Venda
    </button>
</div>

<h3>Nova Venda</h3>

<div class="card p-3 shadow-sm">

    <div class="row">
        <div class="col-md-6">
            <select id="produto" class="form-select mb-2">
                {% for p in produtos %}
                <option value="{{p.id}}"
                        data-descricao="{{p.descricao}}"
                        data-valor="{{p.valor}}"
                        data-estoque="{{p.estoque_atual}}">
                    {{p.descricao}} - R$ {{p.valor}} (Estoque: {{p.estoque_atual}})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <input type="number" id="quantidade"
                   class="form-control mb-2"
                   placeholder="Quantidade" min="1">
        </div>

        <div class="col-md-3">
            <button type="button"
                    onclick="adicionarProduto()"
                    class="btn btn-primary w-100">
                Adicionar
            </button>
        </div>
    </div>

    <hr>

    <h5>Itens da Venda</h5>
    <ul id="listaProdutos" class="list-group mb-3"></ul>

    <h5>Total: R$ <span id="valorTotal">0.00</span></h5>

    <hr>

    <div class="d-flex gap-2">
        <button onclick="salvarVenda()"
                class="btn btn-success">
            Salvar Venda
        </button>      
    </div>

</div>

<hr>

<div id="registroVenda" style="display:none;">
    <h5>Venda Atual</h5>

    <ul id="resumoVenda" class="list-group mb-3"></ul>

    <div class="fw-bold mb-3">
        Total da Venda:
        <span id="totalResumo" class="text-success fs-5">
            R$ 0.00
        </span>
    </div>

    <div class="d-flex gap-2">

    <button onclick="imprimirCupom(window.itensUltimaVenda)"
            class="btn btn-dark">
        Imprimir
    </button>

    <!-- üî¥ BOT√ÉO CANCELAR VENDA -->
    <button onclick="cancelarVenda()"
            class="btn btn-danger">
        Cancelar Venda
    </button>

</div>
</div>

<script>

let itensVenda = [];
let totalVenda = 0;
let estoqueControle = {};
window.itensUltimaVenda = [];
window.numeroVendaAtual = null;
window.dataVendaAtual = null;

function atualizarListaVisual(){

    const lista = document.getElementById("listaProdutos");
    lista.innerHTML = "";

    let agrupado = {};

    itensVenda.forEach(item => {

        if(!agrupado[item.id]){
            agrupado[item.id] = {
                descricao: item.descricao,
                valor: item.valor,
                quantidade: 0
            };
        }

        agrupado[item.id].quantidade += 1;
    });

    Object.keys(agrupado).forEach(id => {

        const produto = agrupado[id];
        const totalItem = produto.quantidade * produto.valor;

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        li.innerHTML = `
            <span>
                ${produto.quantidade}x ${produto.descricao}
                <br>
                <small>Total: R$ ${totalItem.toFixed(2)}</small>
            </span>
            <button class="btn btn-sm btn-danger">X</button>
        `;

        li.querySelector("button").addEventListener("click", function(){

            const index = itensVenda.findIndex(i => i.id == id);

            if(index > -1){
                totalVenda -= produto.valor;
                estoqueControle[id] -= 1;
                atualizarEstoqueSelect(id, -1);
                itensVenda.splice(index,1);
            }

            atualizarListaVisual();
        });

        lista.appendChild(li);
    });

    document.getElementById("valorTotal").innerText =
        totalVenda.toFixed(2);
}

function atualizarEstoqueSelect(id, quantidadeAlterada){

    const select = document.getElementById("produto");

    for(let i = 0; i < select.options.length; i++){

        if(select.options[i].value == id){

            let estoqueAtual = parseInt(select.options[i].getAttribute("data-estoque"));

            estoqueAtual -= quantidadeAlterada;

            select.options[i].setAttribute("data-estoque", estoqueAtual);

            const descricao = select.options[i].getAttribute("data-descricao");
            const valor = parseFloat(select.options[i].getAttribute("data-valor"));

            select.options[i].innerHTML =
                `${descricao} - R$ ${valor.toFixed(2)} (Estoque: ${estoqueAtual})`;

            break;
        }
    }
}
    
function adicionarProduto(){

    const select = document.getElementById("produto");
    const quantidadeInput = document.getElementById("quantidade").value;

    const quantidade = parseInt(quantidadeInput);

    if(isNaN(quantidade) || quantidade < 1){
        alert("Informe quantidade v√°lida");
        return;
    }

    const option = select.options[select.selectedIndex];

    const id = option.value;

    const descricao = option.getAttribute("data-descricao");
    const valor = parseFloat(option.getAttribute("data-valor"));
    const estoqueDisponivel = parseInt(option.getAttribute("data-estoque"));

    if(!descricao || isNaN(valor) || isNaN(estoqueDisponivel)){
        alert("Erro ao ler dados do produto.");
        return;
    }

    if(!estoqueControle[id]){
        estoqueControle[id] = 0;
    }

    if((estoqueControle[id] + quantidade) > estoqueDisponivel){
        alert("Estoque insuficiente!");
        return;
    }

    for(let i = 0; i < quantidade; i++){
        const item = {id, descricao, valor};
        itensVenda.push(item);
        totalVenda += valor;
        estoqueControle[id] += 1;
    }

    atualizarEstoqueSelect(id, quantidade);
    
    atualizarListaVisual();
    document.getElementById("quantidade").value = "";
}

function salvarVenda(){

    if(itensVenda.length === 0){
        alert("Adicione pelo menos um item");
        return;
    }

    // üî• ABRE JANELA IMEDIATAMENTE (evita bloqueio)
    let janelaImpressao = window.open('', '', 'width=300,height=800');

    fetch("/salvar_venda", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            itens: itensVenda
        })
    })
    .then(res => res.json())
    .then(data => {

        if(data.erro){
            alert(data.erro);
            janelaImpressao.close();
            return;
        }

        if(data.alertas && data.alertas.length > 0){
            alert("‚ö† Estoque baixo:\n\n" + data.alertas.join("\n"));
        }

        const resumo = document.getElementById("resumoVenda");
        resumo.innerHTML = "";

        window.itensUltimaVenda = [...itensVenda];

        let totalResumo = 0;
        let agrupado = {};

        itensVenda.forEach(item => {

            if(!agrupado[item.id]){
                agrupado[item.id] = {
                    descricao: item.descricao,
                    valor: item.valor,
                    quantidade: 0
                };
            }

            agrupado[item.id].quantidade += 1;
        });

        Object.keys(agrupado).forEach(id => {

            const produto = agrupado[id];
            const totalItem = produto.quantidade * produto.valor;

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            li.innerHTML = `
                <span>${produto.quantidade}x ${produto.descricao}</span>
                <strong>R$ ${totalItem.toFixed(2)}</strong>
            `;

            resumo.appendChild(li);
            totalResumo += totalItem;
        });

        document.getElementById("totalResumo").innerText =
            "R$ " + totalResumo.toFixed(2);

        document.getElementById("registroVenda").style.display = "block";

        window.numeroVendaAtual = data.numero_venda;
        window.dataVendaAtual = data.data_venda;

        imprimirCupom(window.itensUltimaVenda, janelaImpressao);

        atualizarEstoqueVisual();
        
        // Reset
        document.getElementById("listaProdutos").innerHTML = "";
        document.getElementById("valorTotal").innerText = "0.00";
        itensVenda = [];
        estoqueControle = {};
        totalVenda = 0;
    });
}

function atualizarEstoqueVisual() {

    fetch("/estoque_atual")
        .then(response => response.json())
        .then(data => {

            const select = document.getElementById("produto");

            data.forEach(produto => {

                const id = produto[0];
                const novoEstoque = produto[1];

                for(let i = 0; i < select.options.length; i++){

                    if(select.options[i].value == id){

                        // Atualiza apenas o estoque no dataset
                        select.options[i].dataset.estoque = novoEstoque;

                        // Pega valores j√° existentes
                        const descricao = select.options[i].getAttribute("data-descricao");
                        const valor = select.options[i].getAttribute("data-valor");

                        // Atualiza apenas o texto vis√≠vel
                        select.options[i].innerHTML =
                            `${descricao} - R$ ${parseFloat(valor).toFixed(2)} (Estoque: ${novoEstoque})`;

                        break;
                    }
                }

            });

        });
}
    
function imprimirCupom(listaItens = window.itensUltimaVenda, janela = null){

    if(!listaItens || listaItens.length === 0){
        alert("Nenhum item para imprimir");
        return;
    }

    let total = 0;
    listaItens.forEach(i => total += i.valor);

    if(!janela){
        janela = window.open('', '', 'width=300,height=800');
    }

    let conteudo = `
    <html>
    <head>
        <style>
            body{
                font-family: monospace;
                width:58mm;
                margin:0;
                padding:5px;
                text-align:center;
            }
        
            .item{
                margin:12px 0;   /* üî• AUMENTA ESPA√áAMENTO */
            }
        
            hr{
                border-top:1px dashed black;
                margin:8px 0;
            }
        
            .total{
                font-weight:bold;
                margin-top:15px;
            }
        </style>
    </head>
    <body>

        <h3>COMUNIDADE S√ÉO FRANCISCO DE ASSIS</h3>
        <div>Quermesse</div>
        <hr>

        <div><strong>Venda N¬∫:</strong> ${window.numeroVendaAtual}</div>
        <div><strong>Data:</strong> ${window.dataVendaAtual}</div>

        <hr>
    `;

    listaItens.forEach(item => {
    conteudo += `
        <div class="item">
            <div>${item.descricao}</div>
            <div>R$ ${item.valor.toFixed(2)}</div>
        </div>
        <hr>
    `;
    });

    conteudo += `
        <div class="total">
            TOTAL: R$ ${total.toFixed(2)}
        </div>
        <hr>
        <div>Obrigado pela prefer√™ncia!</div>
    </body>
    </html>
    `;

    janela.document.write(conteudo);
    janela.document.close();
    janela.focus();
    janela.print();
}


function cancelarVenda(){

    if(!window.numeroVendaAtual){
        alert("Nenhuma venda para cancelar");
        return;
    }

    const confirmar = confirm("‚ö† Tem certeza que deseja CANCELAR esta venda?\n\nO estoque ser√° restaurado.");

    if(!confirmar){
        return;
    }

    fetch("/cancelar_venda", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            numero_venda: window.numeroVendaAtual
        })
    })
    .then(res => res.json())
    .then(data => {

        if(data.erro){
            alert(data.erro);
            return;
        }

        alert("Venda cancelada com sucesso!");

        document.getElementById("registroVenda").style.display = "none";

        window.numeroVendaAtual = null;
        window.itensUltimaVenda = [];
    });
}

</script>

{% endblock %}

