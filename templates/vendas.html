
{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between mb-3">
    <a href="/dashboard" class="btn btn-secondary">
        ← Voltar
    </a>

    <button onclick="location.reload()"
            class="btn btn-success">
        Nova Venda
    </button>
</div>

<h3>Nova Venda</h3>

<div class="card p-3 shadow-sm">

    <div class="row">
        <div class="col-md-6">
            <select id="produto" class="form-select mb-2">
                {% for p in produtos %}
                <option value="{{p.id}}"
                        data-descricao="{{p.descricao}}"
                        data-valor="{{p.valor}}"
                        data-estoque="{{p.estoque}}">
                    {{p.descricao}} - R$ {{p.valor}} (Estoque: {{p.estoque}})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <input type="number" id="quantidade"
                   class="form-control mb-2"
                   placeholder="Quantidade" min="1">
        </div>

        <div class="col-md-3">
            <button type="button"
                    onclick="adicionarProduto()"
                    class="btn btn-primary w-100">
                Adicionar
            </button>
        </div>
    </div>

    <hr>

    <h5>Itens da Venda</h5>
    <ul id="listaProdutos" class="list-group mb-3"></ul>

    <h5>Total: R$ <span id="valorTotal">0.00</span></h5>

    <hr>

    <div class="d-flex gap-2">
        <button onclick="salvarVenda()"
                class="btn btn-success">
            Salvar Venda
        </button>      
    </div>

</div>

<hr>

<div id="registroVenda" style="display:none;">
    <h5>Venda Atual</h5>
    <ul id="resumoVenda" class="list-group mb-3"></ul>

    <button onclick="imprimirCupom(window.itensUltimaVenda)"
            class="btn btn-dark">
        Imprimir
    </button>
</div>

<script>

let itensVenda = [];
let totalVenda = 0;
let estoqueControle = {};
window.itensUltimaVenda = [];

function adicionarProduto(){

    const select = document.getElementById("produto");
    const quantidade = parseInt(document.getElementById("quantidade").value);

    if(!quantidade || quantidade < 1){
        alert("Informe quantidade válida");
        return;
    }

    const option = select.options[select.selectedIndex];

    const id = option.value;
    const descricao = option.dataset.descricao;
    const valor = parseFloat(option.dataset.valor);
    const estoqueDisponivel = parseInt(option.dataset.estoque);

    if(!estoqueControle[id]){
        estoqueControle[id] = 0;
    }

    if((estoqueControle[id] + quantidade) > estoqueDisponivel){
        alert("Estoque insuficiente!");
        return;
    }

    for(let i=0;i<quantidade;i++){

        const item = {id, descricao, valor};
        itensVenda.push(item);

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        li.innerHTML = `
            <span>${descricao} - R$ ${valor.toFixed(2)}</span>
            <button class="btn btn-sm btn-danger">X</button>
        `;

        li.querySelector("button").addEventListener("click", function(){

            li.remove();
            totalVenda -= valor;
            estoqueControle[id] -= 1;

            const index = itensVenda.indexOf(item);
            if(index > -1){
                itensVenda.splice(index,1);
            }

            document.getElementById("valorTotal").innerText = totalVenda.toFixed(2);
        });

        document.getElementById("listaProdutos").appendChild(li);

        totalVenda += valor;
        estoqueControle[id] += 1;
    }

    document.getElementById("valorTotal").innerText = totalVenda.toFixed(2);
    document.getElementById("quantidade").value = "";
}


function salvarVenda(){

    fetch("/salvar_venda", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            itens: itensVenda
        })
    })
    .then(res => res.json())
    .then(data => {

        if(data.erro){
            alert(data.erro);
            return;
        }

        if(data.alertas && data.alertas.length > 0){
            alert("⚠ Estoque baixo:\n\n" + data.alertas.join("\n"));
        }

        const resumo = document.getElementById("resumoVenda");
        resumo.innerHTML = "";

        window.itensUltimaVenda = [];

        itensVenda.forEach(item => {

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            li.innerHTML = `
                <span>${item.descricao} - R$ ${item.valor.toFixed(2)}</span>
            `;

            resumo.appendChild(li);
            window.itensUltimaVenda.push(item);
        });

        document.getElementById("registroVenda").style.display = "block";

        window.numeroVendaAtual = data.numero_venda;
        window.dataVendaAtual = data.data_venda;

        imprimirCupom(window.itensUltimaVenda);

        document.getElementById("listaProdutos").innerHTML = "";
        document.getElementById("valorTotal").innerText = "0.00";
        itensVenda = [];
        estoqueControle = {};
        totalVenda = 0;
    });
}


function imprimirCupom(listaItens = window.itensUltimaVenda){

    if(!listaItens || listaItens.length === 0){
        alert("Nenhum item para imprimir");
        return;
    }

    let total = 0;
    listaItens.forEach(i => total += i.valor);

    let janela = window.open('', '', 'width=300,height=600');

    let conteudo = `
    <html>
    <head>
        <style>
            body{
                font-family: monospace;
                width:58mm;
                text-align:center;
            }
            @page{margin:0;}
            .linha{
                text-align:left;
                margin-top:5px;
            }
            .total{
                font-weight:bold;
                margin-top:10px;
            }
            hr{
                border-top:1px dashed black;
                margin:5px 0;
            }
        </style>
    </head>
    <body>

        <h3>PARÓQUIA NOSSA SENHORA</h3>
        <div>Quermesse Beneficente</div>
        <hr>

        <div><strong>Venda Nº:</strong> ${window.numeroVendaAtual}</div>
        <div><strong>Data:</strong> ${window.dataVendaAtual}</div>

        <hr>
    `;

    listaItens.forEach(item=>{
        conteudo += `
            <div class="linha">
                ${item.descricao} <br>
                R$ ${item.valor.toFixed(2)}
            </div>
            <div style="page-break-after:always;"></div>
        `;
    });

    conteudo += `
        <hr>
        <div class="total">
            TOTAL: R$ ${total.toFixed(2)}
        </div>

        <hr>
        <div>Obrigado pela preferência!</div>

    </body>
    </html>
    `;

    janela.document.write(conteudo);
    janela.document.close();
    janela.print();
}

</script>

{% endblock %}
