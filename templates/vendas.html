
{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between mb-3">
    <a href="/dashboard" class="btn btn-secondary">
        ‚Üê Voltar
    </a>

    <button onclick="location.reload()"
            class="btn btn-dark">
        Nova Venda
    </button>
</div>

<h3>Nova Venda</h3>

<div class="card p-3 shadow-sm">

    <div class="row">
        <div class="col-md-6">
            <select id="produto" class="form-select mb-2">
                {% for p in produtos %}
                <option value="{{p.id}}"
                        data-descricao="{{p.descricao}}"
                        data-valor="{{p.valor}}"
                        data-estoque="{{p.estoque_atual}}">
                    {{p.descricao}} - R$ {{p.valor}} (Estoque: {{p.estoque_atual}})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <input type="number" id="quantidade"
                   class="form-control mb-2"
                   placeholder="Quantidade" min="1">
        </div>

        <div class="col-md-3">
            <button type="button"
                    onclick="adicionarProduto()"
                    class="btn btn-primary w-100">
                Adicionar
            </button>
        </div>
    </div>

    <hr>

    <h5>Itens da Venda</h5>
    <ul id="listaProdutos" class="list-group mb-3"></ul>

    <h5>Total: R$ <span id="valorTotal">0.00</span></h5>

    <hr>

    <div class="d-flex gap-2">
        <button onclick="salvarVenda()"
                class="btn btn-success">
            Salvar Venda
        </button>      
    </div>

</div>

<hr>

<div id="registroVenda" style="display:none;">
    <h5>Venda Atual</h5>

    <ul id="resumoVenda" class="list-group mb-3"></ul>

    <div class="fw-bold mb-3">
        Total da Venda:
        <span id="totalResumo" class="text-success fs-5">
            R$ 0.00
        </span>
    </div>

    <div class="d-flex gap-2">

    <button onclick="imprimirCupom(window.itensUltimaVenda)"
            class="btn btn-dark">
        Imprimir
    </button>

    <!-- üî¥ BOT√ÉO CANCELAR VENDA -->
    <button onclick="cancelarVenda()"
            class="btn btn-danger">
        Cancelar Venda
    </button>

</div>
</div>

<script>

let itensVenda = [];
let totalVenda = 0;
let estoqueControle = {};
window.itensUltimaVenda = [];

function atualizarListaVisual(){

    const lista = document.getElementById("listaProdutos");
    lista.innerHTML = "";

    // üî• Agrupar produtos
    let agrupado = {};

    itensVenda.forEach(item => {

        if(!agrupado[item.id]){
            agrupado[item.id] = {
                descricao: item.descricao,
                valor: item.valor,
                quantidade: 0
            };
        }

        agrupado[item.id].quantidade += 1;
    });

    // üî• Montar visual agrupado
    Object.keys(agrupado).forEach(id => {

        const produto = agrupado[id];
        const totalItem = produto.quantidade * produto.valor;

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        li.innerHTML = `
            <span>
                ${produto.quantidade}x ${produto.descricao}
                <br>
                <small>Total: R$ ${totalItem.toFixed(2)}</small>
            </span>
            <button class="btn btn-sm btn-danger">X</button>
        `;

        // üî• Remover UMA unidade por clique
        li.querySelector("button").addEventListener("click", function(){

            const index = itensVenda.findIndex(i => i.id == id);

            if(index > -1){
                totalVenda -= produto.valor;
                estoqueControle[id] -= 1;
                itensVenda.splice(index,1);
            }

            document.getElementById("valorTotal").innerText =
                totalVenda.toFixed(2);

            atualizarListaVisual();
        });

        lista.appendChild(li);
    });

    document.getElementById("valorTotal").innerText =
        totalVenda.toFixed(2);
}


function adicionarProduto(){

    const select = document.getElementById("produto");
    const quantidade = parseInt(document.getElementById("quantidade").value);

    if(!quantidade || quantidade < 1){
        alert("Informe quantidade v√°lida");
        return;
    }

    const option = select.options[select.selectedIndex];

    const id = option.value;
    const descricao = option.dataset.descricao;
    const valor = parseFloat(option.dataset.valor);
    const estoqueDisponivel = parseInt(option.dataset.estoque);

    if(!estoqueControle[id]){
        estoqueControle[id] = 0;
    }

    if((estoqueControle[id] + quantidade) > estoqueDisponivel){
        alert("Estoque insuficiente!");
        return;
    }

    for(let i=0;i<quantidade;i++){

        const item = {id, descricao, valor};
        itensVenda.push(item);

        totalVenda += valor;
        estoqueControle[id] += 1;
    }

    atualizarListaVisual();
    document.getElementById("quantidade").value = "";
}


function salvarVenda(){

    fetch("/salvar_venda", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            itens: itensVenda
        })
    })
    .then(res => res.json())
    .then(data => {

        if(data.erro){
            alert(data.erro);
            return;
        }

        if(data.alertas && data.alertas.length > 0){
            alert("‚ö† Estoque baixo:\n\n" + data.alertas.join("\n"));
        }

        const resumo = document.getElementById("resumoVenda");
        resumo.innerHTML = "";

        window.itensUltimaVenda = [];
        let totalResumo = 0;

        // üî• AGRUPAR PARA RESUMO
        let agrupado = {};

        itensVenda.forEach(item => {

            if(!agrupado[item.id]){
                agrupado[item.id] = {
                    descricao: item.descricao,
                    valor: item.valor,
                    quantidade: 0
                };
            }

            agrupado[item.id].quantidade += 1;
        });

        Object.keys(agrupado).forEach(id => {

            const produto = agrupado[id];
            const totalItem = produto.quantidade * produto.valor;

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            li.innerHTML = `
                <span>
                    ${produto.quantidade}x ${produto.descricao}
                </span>
                <strong>R$ ${totalItem.toFixed(2)}</strong>
            `;

            resumo.appendChild(li);

            for(let i=0;i<produto.quantidade;i++){
                window.itensUltimaVenda.push({
                    id,
                    descricao: produto.descricao,
                    valor: produto.valor
                });
            }

            totalResumo += totalItem;
        });

        document.getElementById("totalResumo").innerText =
            "R$ " + totalResumo.toFixed(2);

        document.getElementById("registroVenda").style.display = "block";

        window.numeroVendaAtual = data.numero_venda;
        window.dataVendaAtual = data.data_venda;

        imprimirCupom(window.itensUltimaVenda);

        // Reset
        document.getElementById("listaProdutos").innerHTML = "";
        document.getElementById("valorTotal").innerText = "0.00";
        itensVenda = [];
        estoqueControle = {};
        totalVenda = 0;
    });
}
    
</script>

{% endblock %}

